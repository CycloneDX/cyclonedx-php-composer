# For details of what checks are run for PRs please refer below
# docs: https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: PHP CI

on:
  push:
    branches: ["master"]
  pull_request:
  workflow_dispatch:
  schedule:
    # schedule weekly tests, since dependencies are not intended to be pinned
    # this means: at 23:42 on Fridays
    - cron: '42 23 * * 5'

env:
  PHP_PROJECT_EXT: dom,json,xmlwriter
  REPORTS_DIR: CI_reports

jobs:
  tests:
    name: Tests (${{ matrix.os}}, ${{ matrix.php }}, ${{ matrix.composer}}, ${{ matrix.dependencies }})
    runs-on: ${{ matrix.os }}
    env:
      REPORTS_ARTIFACT: tests-reports
    strategy:
      fail-fast: false
      matrix:
        os: [ "ubuntu-latest" ]
        php:
          - "8.0" # highest supported
          - "7.4"
          - "7.3"
          - "7.2"
          - "7.1" # lowest supported
        composer: [ 2 ]
        dependencies: [ "lowest", "highest" ]
        include:
          - # windows cutting edge highest
            os: windows-latest
            php: "8.0"
            composer: 2
            dependencies: "highest"
          - # macos cutting edge highest
            os: macos-latest
            php: "8.0"
            composer: 2
            dependencies: "highest"
          - # lowest supported php/composer/deps
            os: ubuntu-latest
            php: "7.1"
            composer: 1
            dependencies: "lowest"
    timeout-minutes: 30
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: dir setup
        run: mkdir ${{ env.REPORTS_DIR }}
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:v${{ matrix.composer }}
          coverage: pcov,xdebug
      - name: Determine composer cache directory on Linux/macOS
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Determine composer cache directory on Windows
        if: ${{ matrix.os == 'windows-latest' }}
        run: ECHO "COMPOSER_CACHE_DIR_PATH=~\AppData\Local\Composer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php${{ matrix.php }}-composerV${{ matrix.composer }}-${{ matrix.dependencies }}-${{ hashFiles('**/composer.json') }}
          restore-keys: php${{ matrix.php }}-composerV${{ matrix.composer }}-${{ matrix.dependencies }}-
      - name: Validate composer.json and composer.lock
        run: >
          composer validate
          --no-interaction
      - name: Install lowest dependencies
        if: ${{ matrix.dependencies == 'lowest' }}
        run: composer update --prefer-dist --no-interaction --no-progress --prefer-lowest
      - name: Install highest dependencies
        if: ${{ matrix.dependencies == 'highest' }}
        run: composer update --prefer-dist --no-interaction --no-progress
      - name: Run PHPUnit tests
        run: >
          php
          -d zend.assertions=1
          -d assert.exception=1
          -d display_errors=On
          -d error_reporting=-1
          -d log_errors_max_len=0
          -d memory_limit=-1
          vendor/phpunit/phpunit/phpunit
          --log-junit=${{ env.REPORTS_DIR }}/tests.${{ matrix.os }}_php${{ matrix.php }}_composer${{ matrix.composer }}_${{ matrix.dependencies }}.junit.xml
          --coverage-clover=${{ env.REPORTS_DIR }}/coverage.${{ matrix.os}}_php${{ matrix.php }}_composer${{ matrix.composer }}_${{ matrix.dependencies }}.clover.xml
      - name: Artifact reports
        if: ${{ ! cancelled() }}
        # see https://github.com/actions/upload-artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.REPORTS_ARTIFACT }}
          path: ${{ env.REPORTS_DIR }}
          if-no-files-found: error
  code-checker:
    name: Code analysis (${{ matrix.php }}, ${{ matrix.composer }}, ${{ matrix.dependencies }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REPORTS_ARTIFACT: types-reports
    strategy:
      fail-fast: false
      matrix:
        include:
          - # highest supported
            php: "8.0"
            composer: 2
            dependencies: "highest"
          - # lowest supported
            php: "7.1"
            composer: 1
            dependencies: "lowest"
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:v${{ matrix.composer }}
          coverage: none
      - name: Determine composer cache directory
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php${{ matrix.php }}-composer${{ matrix.composer }}-${{ matrix.dependencies }}-${{ hashFiles('**/composer.json') }}
          restore-keys: php${{ matrix.php }}-composer${{ matrix.composer }}-${{ matrix.dependencies }}-
      - name: Install psalm
        run: composer update --prefer-dist --no-interaction --no-progress
        working-directory: tools/psalm
      - name: Install lowest dependencies
        if: ${{ matrix.dependencies == 'lowest' }}
        run: composer update --prefer-dist --no-interaction --no-progress --prefer-lowest
      - name: Install highest dependencies
        if: ${{ matrix.dependencies == 'highest' }}
        run: composer update --prefer-dist --no-interaction --no-progress
      - name: Run Psalm tests
        run: >
          php tools/psalm/vendor/vimeo/psalm/psalm
          --use-baseline=.psalm/baseline-${{ matrix.dependencies }}.xml
          --no-diff
          --no-cache
          --long-progress
          --report=${{ env.REPORTS_DIR }}/psalm.php${{ matrix.php }}_composer${{ matrix.composer }}_${{ matrix.dependencies }}.junit.xml
      - name: Artifact reports
        if: ${{ ! cancelled() }}
        # see https://github.com/actions/upload-artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.REPORTS_ARTIFACT }}
          path: ${{ env.REPORTS_DIR }}
          if-no-files-found: error
  composer-unused:
    name: CompoerUnused
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:v2
          coverage: none
      - name: Determine composer cache directory
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php8.0-composer2-highest-${{ hashFiles('**/composer.json') }}
          restore-keys: php8.0-composer2-highest-
      - name: Install composer-unused
        run: composer update --prefer-dist --no-interaction --no-progress
        working-directory: tools/composer-unused
      - name: Run composer-unused tests
        run: >
          php tools/composer-unused/vendor/icanhazstring/composer-unused/bin/composer-unused
          --no-progress
          --no-interaction
          --excludeDir=tools
  composer-require-checker:
    name: CompoerRequireChecker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:2
          coverage: none
      - name: Determine composer cache directory
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php8.0-composer2-highest-${{ hashFiles('**/composer.json') }}
          restore-keys: php8.0-composer2-highest-
      - name: Install composer-require-checker
        run: composer update --prefer-dist --no-interaction --no-progress
        working-directory: tools/composer-require-checker
      - name: Install dependencies
        run: composer update --no-dev --prefer-dist --no-interaction --no-progress
      - name: Run composer-require-checker tests
        run: >
          php tools/composer-require-checker/vendor/maglnet/composer-require-checker/bin/composer-require-checker
          --no-interaction
          || :  # this report is optional
  coding-standards:
    name: Coding Standards
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:2
          coverage: none
      - name: Determine composer cache directory
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php8.0-composer2-highest-${{ hashFiles('**/composer.json') }}
          restore-keys: php8.0-composer2-highest-
      - name: Install PHP-CS-Fixer
        run: composer update --prefer-dist --no-interaction --no-progress
        working-directory: tools/php-cs-fixer
      - name: Run PHP-CS-Fixer tests
        run: >
          php tools/php-cs-fixer/vendor/friendsofphp/php-cs-fixer/php-cs-fixer
          fix
          --dry-run
          --diff-format=udiff
          --using-cache=no
          --show-progress=dots
          --no-interaction
  demo:
    name: Demo "${{ matrix.subject }}" (${{ matrix.php }}, ${{ matrix.composer }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REPORTS_ARTIFACT: demo-output
    strategy:
      fail-fast: false
      matrix:
        include:
          - subject: symfony
            deps-pinned: false
            # highest supported by the project
            php: "8.0"
            composer: 2
          - subject: symfony
            deps-pinned: false
            # lowest supported by the project
            php: "7.1"
            composer: 1
          - subject: laravel-7.12.0
            deps-pinned: true
            # highest supported by this demo
            php: "7.4"
            composer: 2
          - subject: laravel-7.12.0
            deps-pinned: true
            # lowest supported by this demo
            php: "7.2"
            composer: 1
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
      - name: dir setup
        run: |
          REPORTS_DIR_PATH="$(pwd -P)/$REPORTS_DIR/${{ matrix.subject }}"
          mkdir -p "$REPORTS_DIR_PATH"
          echo "REPORTS_DIR_PATH=$REPORTS_DIR_PATH" >> $GITHUB_ENV
      - name: Generate temporary DEMO_RUN_DIR_PATH
        if: ${{ 1 == matrix.composer }}
        # composer1 cannot run self-depending installs within sub-directories
        run: echo "DEMO_RUN_DIR_PATH=$(demo/$DEMO_SUBJECT/project/temp_setup-helper.sh)" >> $GITHUB_ENV
        env:
          DEMO_SUBJECT: ${{ matrix.subject }}
      - name: Set DEMO_RUN_DIR_PATH
        if: ${{ 1 != matrix.composer }}
        run : echo "DEMO_RUN_DIR_PATH=$(pwd -P)/demo/$DEMO_SUBJECT/project" >> $GITHUB_ENV
        env:
          DEMO_SUBJECT: ${{ matrix.subject }}
      - name: Setup PHP
        # see https://github.com/shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ env.PHP_PROJECT_EXT }}
          tools: composer:v${{ matrix.composer }}
          coverage: none
      - name: Determine composer cache directory
        run: echo "COMPOSER_CACHE_DIR_PATH=$(composer config cache-dir)" >> $GITHUB_ENV
      - name: Cache dependencies installed with composer
        # see https://github.com/actions/cache
        uses: actions/cache@v2.1.5
        with:
          path: ${{ env.COMPOSER_CACHE_DIR_PATH }}
          key:          php${{ matrix.php }}-composer${{ matrix.composer }}-highest-${{ hashFiles('**/composer.json') }}
          restore-keys: php${{ matrix.php }}-composer${{ matrix.composer }}-highest-
      - name: Install dependencies (non-pinned)
        if: ${{ ! matrix.deps-pinned }}
        run: composer update --prefer-dist --no-interaction --no-progress
        working-directory: ${{ env.DEMO_RUN_DIR_PATH }}
      - name: Install dependencies (pinned)
        if: ${{ matrix.deps-pinned }}
        run: composer install --prefer-dist --no-interaction --no-progress
        working-directory: ${{ env.DEMO_RUN_DIR_PATH }}
      - name: Show help
        run: >
          composer make-bom
          --help
          > ${{ env.REPORTS_DIR_PATH }}/help.php${{ matrix.php }}_composer${{ matrix.composer }}.txt
        working-directory: ${{ env.DEMO_RUN_DIR_PATH }}
      - name: Make XML SBOM
        run: >
          composer make-bom
          -vvv
          --exclude-dev
          --output-file=${{ env.REPORTS_DIR_PATH }}/bom.php${{ matrix.php }}_composer${{ matrix.composer }}.xml
        working-directory: ${{ env.DEMO_RUN_DIR_PATH }}
      - name: Make JSON SBOM
        run: >
          composer make-bom
          -vvv
          --exclude-dev
          --output-file=${{ env.REPORTS_DIR_PATH }}/bom.php${{ matrix.php }}_composer${{ matrix.composer }}.json
          --json
        working-directory: ${{ env.DEMO_RUN_DIR_PATH }}
      - name: Artifact reports
        if: ${{ ! cancelled() }}
        # see https://github.com/actions/upload-artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.REPORTS_ARTIFACT }}
          path: ${{ env.REPORTS_DIR }}
          if-no-files-found: error
